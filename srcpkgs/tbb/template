# Template file for 'tbb'
pkgname=tbb
version=2021.5.0
revision=1
wrksrc="oneTBB-${version}"
build_style=cmake
makedepends="libgomp-devel libhwloc-devel"
short_desc="Intel Threading Building Blocks"
maintainer="Andrea Brancaleoni <abc@pompel.me>"
license="Apache-2.0"
homepage="https://www.threadingbuildingblocks.org"
changelog="https://raw.githubusercontent.com/oneapi-src/oneTBB/master/RELEASE_NOTES.md"
distfiles="https://github.com/oneapi-src/oneTBB/archive/refs/tags/v${version}.tar.gz"
checksum=e5b57537c741400cf6134b428fc1689a649d7d38d9bb9c1b6d64f092ea28178a
make_check=no  # checks fail upstream on i686

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	makedepends+=" libucontext-devel"
	configure_args+=" -DCMAKE_CXX_STANDARD_LIBRARIES=-lucontext"
fi

if [ "$XBPS_TARGET_NO_ATOMIC8" ]; then
	makedepends+=" libatomic-devel"
	# XXX: should be some linking related flag, but couldn't find how to append to them
	configure_args+=" -DCMAKE_CXX_FLAGS=-latomic"
fi

post_extract() {
	# alternative might be:
	# https://git.alpinelinux.org/cgit/aports/tree/testing/libtbb/glibc-struct-mallinfo.patch
	if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
		vsed -e "s@#define MALLOC_UNIXLIKE_OVERLOAD_ENABLED __linux__@@" \
		  -i src/tbbmalloc_proxy/proxy.h
	fi
}

tbb-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/cmake
		vmove usr/lib/pkgconfig
		vmove "usr/lib/*.so"
	}
}
